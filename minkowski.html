<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minkowski AABB collision</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
</head>
<body>
<script>
    class AABB {
        center = createVector(0, 0);
        extents = createVector(0, 0);

        constructor(center, extents) {
            this.center = center;
            this.extents = extents;
        }

        getMin() {
            return p5.Vector.sub(this.center, this.extents);
        }

        getMax() {
            return p5.Vector.add(this.center, this.extents);
        }

        get min() {
            return this.getMin();
        }

        get max() {
            return this.getMax();
        }

        getSize() {
            return p5.Vector.mult(this.extents, 2);
        }

        overlaps(aabb) {
            return aabb.center.x - aabb.extents.x < this.center.x + this.extents.x &&
                aabb.center.x + aabb.extents.x > this.center.x - this.extents.x &&
                aabb.center.y - aabb.extents.y < this.center.y + this.extents.y &&
                aabb.center.y + aabb.extents.y > this.center.y - this.extents.y;
        }

        AABBCollision(aabb) {
            if (this.overlaps(aabb)) {
                let difference = p5.Vector.sub(aabb.center, this.center);
                let totalExtents = p5.Vector.add(aabb.extents, this.extents);

                totalExtents.x *= Math.sign(difference.x);
                totalExtents.y *= Math.sign(difference.y);

                let overlap = p5.Vector.sub(totalExtents, difference);

                stroke(255, 0, 0);
                line(this.center.x,
                    this.center.y,
                    this.center.x + overlap.x,
                    this.center.y + overlap.y);

                if (Math.abs(difference.y) > Math.abs(difference.x)) {
                    this.center.y -= overlap.y;
                    if (difference.y > 0) {
                        this.setOnGround(true);
                    }
                } else if (Math.abs(difference.y) < Math.abs(difference.x)) {
                    this.center.x -= overlap.x;
                } else {
                    console.log("hmmm")
                }
            }
        }

        draw(r, g, b) {
            stroke(0);
            fill(...arguments);
            rectMode(CENTER);
            rect(this.center.x, this.center.y, this.extents.x * 2, this.extents.y * 2);
        }
    }

    class Player extends AABB {

        #vel = createVector(0, 0);
        #jumping = false;

        update() {
            this.control();
            this.move();
            this.wallCollision();
        }

        control() {
            this.#vel.y += .3;

            if (keyIsDown(65)) {
                if (keyIsDown(65) && !keyIsDown(68))
                    player.walk(-speed)
            } else if (keyIsDown(68)) {
                if (!keyIsDown(65) && keyIsDown(68))
                    player.walk(speed)
            }

            if (keyIsDown(32)) {
                player.jump();
            }
        }

        move() {
            this.center.add(this.#vel);
            this.#vel.x = 0;
        }


        wallCollision() {

            if (this.center.x + this.extents.x > width) {
                this.center.x = width - this.extents.x;
            }
            if (this.center.x - this.extents.x < 0) {
                this.center.x = this.extents.x;
            }

            if (this.center.y + this.extents.y > height) {
                this.center.y = height - this.extents.y;
                this.#vel.y = 0;
                this.#jumping = false;
            }
        }

        walk(x) {
            this.#vel.x = x;
        }

        jump() {
            if (!this.#jumping) {
                this.#vel.y = -6;
                this.#jumping = true;
            }
        }

        setOnGround(value) {
            this.#jumping = !value;
            this.#vel.y = 0;
        }

        getVel() {
            return this.#vel;
        }
    }


    let player;
    let obstacles;
    let map = [
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 1,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 1,
        0, 0, 0, 0, 0, 0, 1, 0, 0, 1,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
    ];
    let speed;

    function setup() {
        createCanvas(320, 320);
        player = new Player(createVector(32, 32), createVector(12, 12));
        obstacles = [];

        for (let x = 0; x < 10; x++)
            for (let y = 0; y < 10; y++) {
                let size = 16;
                if (map[x + y * 10] > 0) obstacles.push(new AABB(
                    createVector(x * size * 2 + size, y * size * 2+ size),
                    createVector(size, size)))
            }

        speed = 2;
    }

    function draw() {
        background(150);

        player.draw(0, 0, 0);

        player.update();
        for (let obstacle of obstacles) {
            player.AABBCollision(obstacle);
            obstacle.draw(0, 255, 0);
        }
        //obstacle.AABBCollision(player);
    }
</script>
</body>
</html>